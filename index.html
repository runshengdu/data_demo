<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>大模型评测 - qq3dworld.com</title>
  <link rel="stylesheet" href="./styles.css">
</head>
<body>
  <header></header>
  <main>
    <div id="data-load-warning" style="display: none; background: #fffbeb; color: #b45309; border: 1px solid #fde68a; padding: 0.75rem 1rem; border-radius: 4px; margin-bottom: 1rem; font-size: 0.875rem;">
      数据加载失败，请使用本地静态服务器打开页面（不要直接用 file:// 打开），并检查 data_eval.csv 与 data_others.csv 是否存在。
    </div>
    <!-- Agentic Index Tab -->
    <div id="agentic" class="tab-content active">
      <div class="leaderboard-card">
        <h3 class="section-title">智能体指数表现排行榜</h3>
        <div class="section-meta">
          <span class="meta-updated">更新时间：2026-1-27</span>
          <span class="meta-desc">智能体指数衡量的是LLM的通用Agent能力，包括记忆能力、工具调用、规划、编程等，该指数综合了多个评测集的平均表现，分数越高代表模型在Agent任务中的能力越强。该指数的相关测试尚未完成，目前排名不代表最终结果。</span>
        </div>
        <div class="bars" id="agentic-bars"></div>
      </div>

      <h3 class="section-title" style="margin-top: 2rem;">核心评估指标</h3>
      <div id="metrics-grid" class="grid">
        <!-- Content loaded dynamically via renderMetricsTiles() -->
      </div>

      <div class="leaderboard-card" style="margin-top: 2rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
          <h3 class="section-title" style="margin-bottom: 0;">模型性价比分析 (Performance vs Price)</h3>
          <div style="display: flex; gap: 0.5rem;">
            <select id="price-chart-scenario" onchange="updatePriceChartScenario(this.value)" style="padding: 0.5rem; border-radius: 4px; border: 1px solid #e2e8f0; min-width: 150px;">
              <option value="agentic">智能体指数 (Agentic Index)</option>
              <option value="finance">金融指数 (Finance Index)</option>
              <option value="ecommerce">电商指数 (E-commerce Index)</option>
            </select>
            <select id="price-chart-submetric" onchange="updatePriceChartSubmetric(this.value)" style="padding: 0.5rem; border-radius: 4px; border: 1px solid #e2e8f0; min-width: 150px;">
              <!-- Populated by JS -->
            </select>
          </div>
        </div>
        <div id="price-chart" style="width: 100%; height: 400px;"></div>
        <div id="price-chart-legend" style="display: flex; flex-wrap: wrap; gap: 1rem; margin-top: 1rem; justify-content: center; font-size: 0.9rem; color: #666;"></div>
      </div>
    </div>

    <!-- Model Selection Tab -->
    <div id="selection" class="tab-content">
      <div class="leaderboard-card">
        <h3 class="section-title">模型选型</h3>
        <div class="section-meta">
          <span class="meta-desc">根据你自定义的场景和指标权重，以获得最符合自己需求的模型。</span>
        </div>
        
        <div class="selection-controls" style="display: flex; flex-direction: column; gap: 1.5rem;">
          <!-- Step 1: Scenario -->
          <div class="control-group">
            <h4 style="margin-bottom: 0.5rem;">1. 选择场景 (Scenario)</h4>
            <select id="sel-scenario" class="form-select" onchange="updateSelectionResults()" style="width: 100%; padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 6px;">
              <option value="agentic">通用智能体（智能体指数)</option>
              <option value="finance">金融 (金融指数) - 暂无数据</option>
              <option value="ecommerce">电商 (电商指数) - 暂无数据</option>
            </select>
          </div>

          <!-- Step 2: Weights -->
          <div class="control-group">
            <h4 style="margin-bottom: 0.5rem;">2. 分配权重 (Weights 1-5)</h4>
            <div class="weight-sliders" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
              <div class="slider-item" style="background: #f8fafc; padding: 1rem; border-radius: 6px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                  <label>性能强</label>
                  <span id="val-perf" style="font-weight: bold; color: #2563eb;">3</span>
                </div>
                <input type="range" id="w-perf" min="1" max="5" value="3" oninput="updateSliderVal('perf'); updateSelectionResults()" style="width: 100%;">
              </div>
              <div class="slider-item" style="background: #f8fafc; padding: 1rem; border-radius: 6px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                  <label>速度快</label>
                  <span id="val-speed" style="font-weight: bold; color: #2563eb;">3</span>
                </div>
                <input type="range" id="w-speed" min="1" max="5" value="3" oninput="updateSliderVal('speed'); updateSelectionResults()" style="width: 100%;">
              </div>
              <div class="slider-item" style="background: #f8fafc; padding: 1rem; border-radius: 6px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                  <label>价格低</label>
                  <span id="val-price" style="font-weight: bold; color: #2563eb;">3</span>
                </div>
                <input type="range" id="w-price" min="1" max="5" value="3" oninput="updateSliderVal('price'); updateSelectionResults()" style="width: 100%;">
              </div>
              <div class="slider-item" style="background: #f8fafc; padding: 1rem; border-radius: 6px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                  <label>上下文窗口</label>
                  <span id="val-context" style="font-weight: bold; color: #2563eb;">3</span>
                </div>
                <input type="range" id="w-context" min="1" max="5" value="3" oninput="updateSliderVal('context'); updateSelectionResults()" style="width: 100%;">
              </div>
            </div>
          </div>

          <!-- Step 3: Filters -->
          <div class="control-group">
            <h4 style="margin-bottom: 0.5rem;">3. 筛选条件 (Filters)</h4>
            <div class="filters-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
              <div class="filter-item">
                <label style="display: block; margin-bottom: 0.25rem; font-size: 0.9rem; color: #64748b;">模型类型 (Type)</label>
                <select id="sel-opensource" class="form-select" onchange="updateSelectionResults()" style="width: 100%; padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 6px;">
                  <option value="all">全部 (All)</option>
                  <option value="y">开源 (Open Source)</option>
                  <option value="n">闭源 (Closed Source)</option>
                </select>
              </div>
              <div class="filter-item">
                <label style="display: block; margin-bottom: 0.25rem; font-size: 0.9rem; color: #64748b;">厂商国家 (Nation)</label>
                <select id="sel-nation" class="form-select" onchange="updateSelectionResults()" style="width: 100%; padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 6px;">
                  <option value="all">全部 (All)</option>
                  <option value="中国">中国 (China)</option>
                  <option value="美国">美国 (USA)</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <!-- Step 4: Results -->
        <div class="results-section" style="margin-top: 2rem;">
          <h4 style="margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid #e2e8f0;">推荐结果 (Recommendations)</h4>
          <div id="selection-results" class="selection-results-grid"></div>
        </div>
      </div>
    </div>

    <!-- Comparison Tab -->
    <div id="comparison" class="tab-content">
      <div class="leaderboard-card">
        <h3 class="section-title">模型与评测集对比</h3>
        
        <div class="comparison-controls">
          <div class="control-group">
            <h4>选择模型</h4>
            <div class="custom-select" id="model-select-container">
              <div class="select-trigger" onclick="toggleDropdown(event, 'model-dropdown')">
                <div class="selected-tags" id="model-tags"></div>
                <span class="placeholder">点击搜索并选择模型...</span>
              </div>
              <div class="select-dropdown" id="model-dropdown">
                <input type="text" class="search-input" placeholder="搜索模型..." oninput="filterOptions('model', this.value)" onclick="event.stopPropagation()">
                <div id="model-options" class="options-list"></div>
              </div>
            </div>
          </div>
          <div class="control-group">
            <h4>选择评测集</h4>
            <div class="custom-select" id="benchmark-select-container">
              <div class="select-trigger" onclick="toggleDropdown(event, 'benchmark-dropdown')">
                <div class="selected-tags" id="benchmark-tags"></div>
                <span class="placeholder">点击搜索并选择评测集...</span>
              </div>
              <div class="select-dropdown" id="benchmark-dropdown">
                <input type="text" class="search-input" placeholder="搜索评测集..." oninput="filterOptions('benchmark', this.value)" onclick="event.stopPropagation()">
                <div id="benchmark-options" class="options-list"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="comparison-table-container">
          <table id="comparison-table">
            <thead>
              <tr id="table-header">
                <!-- Headers will be injected here -->
              </tr>
            </thead>
            <tbody id="table-body">
              <!-- Body will be injected here -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Methods Tab -->
    <div id="methods" class="tab-content">
      <div id="methods-content"></div>
    </div>

    <!-- Finance Index Tab -->
    <div id="finance" class="tab-content">
      <div class="coming-soon-container">
        <h3>金融指数</h3>
        <p>面向金融行业的专业评估指标正在开发中。</p>
      </div>
    </div>

    <!-- E-commerce Index Tab -->
    <div id="ecommerce" class="tab-content">
      <div class="coming-soon-container">
        <h3>电商指数</h3>
        <p>面向电商行业的专业评估指标正在开发中。</p>
      </div>
    </div>
  </main>
  <footer></footer>

  <script src="./data.js"></script>
  <script src="./layout.js"></script>
  <script>
    // Tab Switching
    let methodsTabHtml = null;
    let methodsTabLoadingPromise = null;

    async function loadMethodsTab(forceReload = false) {
      const container = document.getElementById('methods-content');
      if (!container) return;

      if (!forceReload && methodsTabHtml) {
        container.innerHTML = methodsTabHtml;
        return;
      }

      if (methodsTabLoadingPromise) {
        await methodsTabLoadingPromise;
        return;
      }

      methodsTabLoadingPromise = (async () => {
        container.innerHTML = `
          <div class="leaderboard-card">
            <h3 class="section-title">测试方法说明</h3>
            <div class="section-meta"><span class="meta-desc">正在加载…</span></div>
          </div>
        `;

        const resp = await fetch('./methods.html', { cache: 'no-store' });
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const html = await resp.text();

        const doc = new DOMParser().parseFromString(html, 'text/html');
        const card = doc.querySelector('main .leaderboard-card') || doc.querySelector('.leaderboard-card');

        methodsTabHtml = card ? card.outerHTML : `
          <div class="leaderboard-card">
            <h3 class="section-title">测试方法说明</h3>
            <div class="section-meta">
              <span class="meta-desc">内容解析失败，请打开 <a href="./methods.html">methods.html</a> 查看。</span>
            </div>
          </div>
        `;

        container.innerHTML = methodsTabHtml;
      })()
        .catch((err) => {
          const msg = (err && err.message) ? err.message : String(err);
          container.innerHTML = `
            <div class="leaderboard-card">
              <h3 class="section-title">测试方法说明</h3>
              <div class="section-meta">
                <span class="meta-desc">加载失败：${msg}。请打开 <a href="./methods.html">methods.html</a> 查看。</span>
              </div>
            </div>
          `;
        })
        .finally(() => {
          methodsTabLoadingPromise = null;
        });

      await methodsTabLoadingPromise;
    }

    async function showTab(tabId) {
      // Update buttons
      document.querySelectorAll('.tab-btn').forEach(btn => {
        const onclickAttr = btn.getAttribute('onclick');
        if (onclickAttr) {
          btn.classList.toggle('active', onclickAttr.includes(tabId));
        }
      });
      // Update content
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.toggle('active', content.id === tabId);
      });

      if (tabId === 'methods') {
        await loadMethodsTab();
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      injectLayout('home');
      await ensureDataLoaded();
      const warning = document.getElementById('data-load-warning');
      if (warning) {
        warning.style.display = (models && models.length > 0) ? 'none' : 'block';
      }
      renderAgenticBars("agentic-bars");
      renderPriceChart("price-chart");
      renderMetricsTiles("metrics-grid");
      initComparison();
      updateSelectionResults();
    });

    // Model Selection Logic
    function updateSliderVal(id) {
      document.getElementById('val-' + id).textContent = document.getElementById('w-' + id).value;
    }

    async function updateSelectionResults() {
      await ensureDataLoaded();
      
      const scenario = document.getElementById('sel-scenario').value;
      const wPerf = parseInt(document.getElementById('w-perf').value);
      const wSpeed = parseInt(document.getElementById('w-speed').value);
      const wPrice = parseInt(document.getElementById('w-price').value);
      const wContext = parseInt(document.getElementById('w-context').value);
      
      const filterOpenSource = document.getElementById('sel-opensource').value;
      const filterNation = document.getElementById('sel-nation').value;
      
      const speeds = models.map(m => parseFloat(m.tokens_per_sec) || 0);
      const prices = models.map(m => (parseFloat(m.cost_usd) || 0) * 7.01 + (parseFloat(m.cost_rmb) || 0));
      const contexts = models.map(m => parseFloat(m.context_window) || 0);

      const maxSpeed = Math.max(...speeds);
      const minSpeed = Math.min(...speeds);
      const maxPrice = Math.max(...prices);
      const minPrice = Math.min(...prices);
      const maxContext = Math.max(...contexts);
      const minContext = Math.min(...contexts);

      const results = models.map(m => {
        // 1. Calculate Score
        // Performance
        let perfScore = 0;
        if (scenario === 'agentic') {
           // Compute average of benchmarks
           const total = benchmarks.reduce((sum, b) => sum + normalizeScore(m.scores[b]), 0);
           perfScore = benchmarks.length ? (total / benchmarks.length) : 0;
        } else {
           // Placeholder for finance/ecommerce
           perfScore = 0; 
        }
        
        // Speed
        const speed = parseFloat(m.tokens_per_sec) || 0;
        const speedScore = maxSpeed === minSpeed ? 100 : ((speed - minSpeed) / (maxSpeed - minSpeed)) * 100;
        
        // Price (Lower is better)
        const price = (parseFloat(m.cost_usd)||0) * 7.01 + (parseFloat(m.cost_rmb)||0);
        // Linear inverse: 0 price -> 100 score, max price -> 0 score
        const priceScore = maxPrice === minPrice ? 100 : ((maxPrice - price) / (maxPrice - minPrice)) * 100;
        
        // Context Window (Larger is better)
        const context = parseFloat(m.context_window) || 0;
        const contextScore = maxContext === minContext ? 100 : ((context - minContext) / (maxContext - minContext)) * 100;
        
        // Weighted Sum
        const totalWeight = wPerf + wSpeed + wPrice + wContext;
        const finalScore = (perfScore * wPerf + speedScore * wSpeed + priceScore * wPrice + contextScore * wContext) / totalWeight;
        
        return {
          model: m,
          finalScore,
          details: { perfScore, speed, speedScore, price, priceScore, context, contextScore }
        };
      });
      
      // 2. Filter
      const filtered = results.filter(r => {
        if (filterOpenSource !== 'all') {
          const openSourceValue = (r.model.open_source || '').toString().trim().toLowerCase();
          const isOS = openSourceValue === 'y';
          if (filterOpenSource === 'y' && !isOS) return false;
          if (filterOpenSource === 'n' && isOS) return false;
        }
        
        if (filterNation !== 'all') {
           if (r.model.nation !== filterNation) return false;
        }
        
        return true;
      });
      
      // 3. Sort
      filtered.sort((a, b) => b.finalScore - a.finalScore);
      
      // 4. Render
      const container = document.getElementById('selection-results');
      if (!container) return; // Guard against missing element

      container.innerHTML = filtered.map((r, idx) => `
        <div class="result-card" style="border: 1px solid var(--border); padding: 1rem; margin-bottom: 1rem; border-radius: var(--radius); background: var(--bg-card);">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
             <div style="display: flex; align-items: center; gap: 0.5rem;">
               <span class="rank-badge" style="background: var(--primary); color: white; width: 24px; height: 24px; border-radius: 2px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-family: monospace;">${idx + 1}</span>
               <strong style="font-size: 1rem; color: var(--primary);">${r.model.name}</strong>
               <span style="font-size: 0.75rem; color: var(--text-muted); border: 1px solid var(--border); padding: 0 4px; border-radius: 2px;">${r.model.provider}</span>
              ${((r.model.open_source || '').toString().trim().toLowerCase() === 'y') ? '<span style="font-size: 0.75rem; background: #f0fdf4; border: 1px solid #86efac; color: #166534; padding: 0 4px; border-radius: 2px;">开源</span>' : ''}
             </div>
             <div style="text-align: right;">
               <div style="font-size: 1.25rem; font-weight: 600; color: var(--primary); font-family: monospace;">${r.finalScore.toFixed(1)}</div>
               <div style="font-size: 0.75rem; color: var(--text-muted);">综合评分</div>
             </div>
          </div>
          
          <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem; font-size: 0.8rem;">
            <div>
              <div style="color: var(--text-muted);">性能</div>
              <div style="font-weight: 500; color: var(--text-main);">${formatPercent(r.details.perfScore)}</div>
            </div>
            <div>
              <div style="color: var(--text-muted);">速度</div>
              <div style="font-weight: 500; color: var(--text-main);">${r.details.speed} token/秒</div>
            </div>
            <div>
              <div style="color: var(--text-muted);">价格</div>
              <div style="font-weight: 500; color: var(--text-main);">${r.details.price.toFixed(2)} RMB/百万输入token</div>
            </div>
            <div>
              <div style="color: var(--text-muted);">上下文</div>
              <div style="font-weight: 500; color: var(--text-main);">${(r.details.context >= 1000) ? (r.details.context/1000).toFixed(0) + 'k' : r.details.context} tokens</div>
            </div>
          </div>
        </div>
      `).join('');
      
      if (filtered.length === 0) {
        container.innerHTML = '<div style="padding: 2rem; text-align: center; color: #64748b;">没有找到匹配的模型 (No models found)</div>';
      }
    }

    // Comparison Logic
    const selectedModels = new Set();
    const selectedBenchmarks = new Set();
    const MAX_SELECTION = 20;

    function initComparison() {
      models.slice(0, MAX_SELECTION).forEach(m => selectedModels.add(m.name));
      benchmarks.slice(0, MAX_SELECTION).forEach(b => selectedBenchmarks.add(b));

      renderSelectors();
      renderComparisonTable();

      // Close dropdowns when clicking outside
      document.addEventListener('click', (e) => {
        if (!e.target.closest('.custom-select')) {
          document.querySelectorAll('.select-dropdown').forEach(d => d.classList.remove('show'));
        }
      });
    }

    function toggleDropdown(event, id) {
      event.stopPropagation();
      const dropdown = document.getElementById(id);
      const isShow = dropdown.classList.contains('show');
      
      // Close all other dropdowns
      document.querySelectorAll('.select-dropdown').forEach(d => d.classList.remove('show'));
      
      if (!isShow) {
        dropdown.classList.add('show');
        dropdown.querySelector('.search-input').focus();
      }
    }

    function filterOptions(type, query) {
      renderOptions(type, query);
    }

    function renderSelectors() {
      renderTags('model');
      renderTags('benchmark');
      renderOptions('model');
      renderOptions('benchmark');
    }

    function renderTags(type) {
      const container = document.getElementById(`${type}-tags`);
      const placeholder = container.nextElementSibling;
      const set = type === 'model' ? selectedModels : selectedBenchmarks;
      
      if (set.size === 0) {
        container.innerHTML = '';
        placeholder.style.display = 'block';
        return;
      }

      placeholder.style.display = 'none';
      container.innerHTML = Array.from(set).map(value => `
        <span class="tag">
          ${value}
          <span class="remove-tag" onclick="event.stopPropagation(); toggleSelection('${type}', '${value}')">&times;</span>
        </span>
      `).join('');
    }

    function renderOptions(type, query = '') {
      const container = document.getElementById(`${type}-options`);
      const set = type === 'model' ? selectedModels : selectedBenchmarks;
      
      let items = [];
      const q = query.toLowerCase();

      if (type === 'model') {
        items = models
          .filter(m => m.name.toLowerCase().includes(q) || (m.provider && m.provider.toLowerCase().includes(q)))
          .map(m => ({
            value: m.name,
            display: `
              <div style="display: flex; flex-direction: column; flex: 1;">
                <span style="color: var(--text-main); font-weight: 500;">${m.name}</span>
                <span style="font-size: 0.75em; color: var(--text-muted);">${m.provider || ''}</span>
              </div>
            `
          }));
      } else {
        items = benchmarks
          .filter(b => {
             const desc = (benchmarkDescriptions[b] || '').toLowerCase();
             return b.toLowerCase().includes(q) || desc.includes(q);
          })
          .map(b => ({
            value: b,
            display: `
              <div style="display: flex; flex-direction: column; flex: 1;">
                <span style="color: var(--text-main); font-weight: 500;">${b}</span>
                ${benchmarkDescriptions[b] ? `<span style="font-size: 0.75em; color: var(--text-muted);">${benchmarkDescriptions[b]}</span>` : ''}
              </div>
            `
          }));
      }

      if (items.length === 0) {
        container.innerHTML = '<div style="padding: 1rem; color: var(--text-muted); text-align: center;">无匹配结果</div>';
        return;
      }

      container.innerHTML = items.map(item => `
        <div class="option-item ${set.has(item.value) ? 'selected' : ''}" 
             onclick="toggleSelection('${type}', '${item.value}')">
          ${item.display}
        </div>
      `).join('');
    }

    function toggleSelection(type, value) {
      const set = type === 'model' ? selectedModels : selectedBenchmarks;
      
      if (set.has(value)) {
        set.delete(value);
      } else {
        if (set.size >= MAX_SELECTION) {
          alert(`最多只能选择 ${MAX_SELECTION} 项`);
          return;
        }
        set.add(value);
      }
      
      renderTags(type);
      renderOptions(type, document.querySelector(`#${type}-dropdown .search-input`).value);
      renderComparisonTable();
    }

    function renderComparisonTable() {
      const thead = document.getElementById('table-header');
      const tbody = document.getElementById('table-body');
      
      const activeModels = models.filter(m => selectedModels.has(m.name));
      const activeBenchmarks = benchmarks.filter(b => selectedBenchmarks.has(b));

      thead.innerHTML = `
        <th>模型</th>
        ${activeBenchmarks.map(b => `<th>${b}</th>`).join('')}
      `;

      if (activeModels.length === 0) {
        tbody.innerHTML = `<tr><td colspan="${activeBenchmarks.length + 1}" style="text-align:center; padding: 2rem;">请选择至少一个模型</td></tr>`;
        return;
      }

      tbody.innerHTML = activeModels.map(m => `
        <tr>
          <td>
            <strong>${m.name}</strong>
            <div style="font-size: 0.8em; color: var(--text-muted);">${m.provider}</div>
          </td>
          ${activeBenchmarks.map(b => {
             const score = m.scores[b];
             return `<td class="score-cell">${formatPercent(score)}</td>`;
          }).join('')}
        </tr>
      `).join('');
    }
  </script>
</body>
</html>
